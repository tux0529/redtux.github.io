<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>胡乱折腾</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="胡乱折腾"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="胡乱折腾"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="胡乱折腾"><meta property="og:url" content="http://tux.red/"><meta property="og:site_name" content="胡乱折腾"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://tux.red/img/og_image.png"><meta property="article:author" content="redtux"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://tux.red/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://tux.red"},"headline":"胡乱折腾","image":["http://tux.red/img/og_image.png"],"author":{"@type":"Person","name":"redtux"},"publisher":{"@type":"Organization","name":"胡乱折腾","logo":{"@type":"ImageObject","url":"http://tux.red/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="胡乱折腾" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">主页</a><a class="navbar-item" href="/archives">存档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/tux0529"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-18T08:46:25.000Z" title="2023/8/18 16:46:25">2023-08-18</time>发表</span><span class="level-item"><time dateTime="2023-08-18T13:13:06.911Z" title="2023/8/18 21:13:06">2023-08-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a></span><span class="level-item">17 分钟读完 (大约2594个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/18/ubuntu-server/">Ubuntu Server 常用管理</a></h1><div class="content"><h2 id="1-重启网络服务："><a href="#1-重启网络服务：" class="headerlink" title="1.重启网络服务："></a>1.重启网络服务：</h2><p>   <code>sudo /etc/init.d/networking restart</code></p>
<p>   或者：</p>
<p>   <code>service networking restart</code></p>
<h2 id="2-设置Nameserver（2种方法）："><a href="#2-设置Nameserver（2种方法）：" class="headerlink" title="2.设置Nameserver（2种方法）："></a>2.设置Nameserver（2种方法）：</h2><ul>
<li>修改<code>/etc/resolv.conf</code>，但此文件会被resolvconf重写，故应该修改resolvconf配置文件<code>/etc/resolvconf/resolv.conf.d/head</code>， 增加：<code>nameserver 202.96.209.133</code></li>
<li>修改<code>/etc/network/interfaces</code>，DNS对应的参数名为<code>dns-nameservers</code>，这里设置的优先级比上一种方法高。如果两种方法都设置了，则都会出现在&#x2F;etc&#x2F;resolv.conf中。</li>
</ul>
<h2 id="3-将用户加入-group："><a href="#3-将用户加入-group：" class="headerlink" title="3.将用户加入 group："></a>3.将用户加入 group：</h2><p><code>usermod -G groupname username</code> (这种会把用户从其他组中去掉，只属于该组)<br>如：<code>usermod -G git git</code> (git只属于git组)</p>
<p><code>usermod -a -G groupname username</code> (把用户添加到这个组，之前所属组不影响)<br>如：<code>usermod -a -G www git</code> (git属于之前git组，也属于www组)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xxx@xxxx:~$ cat /etc/group|grep user1</span><br><span class="line">user1:x:999:user1</span><br><span class="line">xxx@xxxx:~$ cat /etc/group|grep sudo</span><br><span class="line">sudo:x:27:</span><br><span class="line">xxx@xxxx:~$ usermod -G 27 user1</span><br><span class="line">xxx@xxxx:~$ cat /etc/group|grep sudo</span><br><span class="line">sudo:x:27:user1</span><br><span class="line">xxx@xxxx:~$ cat /etc/group|grep user1</span><br><span class="line">user1:x:999:</span><br><span class="line">xxx@xxxx:~$ usermod -a -G 999 user1</span><br><span class="line">xxx@xxxx:~$ cat /etc/group|grep user1</span><br><span class="line">user1:x:999:user1</span><br><span class="line">xxx@xxxx:~$ cat /etc/group|grep sudo</span><br><span class="line">sudo:x:27:user1</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx@xxxx:~$ useradd -r -m -s /bin/bash -G 27 test1 </span><br></pre></td></tr></table></figure>

<h2 id="4-修改时区和时间："><a href="#4-修改时区和时间：" class="headerlink" title="4.修改时区和时间："></a>4.修改时区和时间：</h2><ol>
<li><p>首先查看时区：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redtux@redtux-PC:~$ date -R</span><br><span class="line">Thu, 31 May 2018 00:03:22 +0800</span><br></pre></td></tr></table></figure></li>
<li><p>修改时区，执行sudo tzselect，按提示选择时区.</p>
</li>
<li><p>复制文件到&#x2F;etc目录下 <code>sudo cp /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime</code></p>
</li>
<li><p>更新时间  <code>sudo ntpdate time.windows.com</code></p>
</li>
</ol>
<h2 id="5-搜索文件夹并删除"><a href="#5-搜索文件夹并删除" class="headerlink" title="5.搜索文件夹并删除"></a>5.搜索文件夹并删除</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ./* -name <span class="string">&quot;@eaDir&quot;</span> -<span class="built_in">type</span> d -print0 | xargs -0 <span class="built_in">rm</span> -rf</span><br></pre></td></tr></table></figure>

<h2 id="6-gdisk硬盘分区工具"><a href="#6-gdisk硬盘分区工具" class="headerlink" title="6.gdisk硬盘分区工具"></a>6.gdisk硬盘分区工具</h2><p>gdisk是fdisk分区工具的GPT版，MBR分区格式只能支持最大2T的硬盘，大于2T的硬盘必须采用GPT格式，gdisk就是针对GPT格式的升级版。</p>
<p>gdisk</p>
<pre><code>  -l /dev/sdX 查看分区信息
</code></pre>
<p>gdisk</p>
<pre><code>  (?|m) 帮助

  n 建立分区

  d 删除分区

  c 更改分区名字
</code></pre>
<p>　   I 显示分区的详细信息</p>
<pre><code>  p 显示分区信息

  t 转换分区类型

  a 将指定分区设置/取消 活动分区

  l 查看分区类型

  o 重建分区表

  v 验证分区表，显示剩余没有被分区划分的扇区数量

  q 退出不保存，不保存，所有的修改都不生效

  w 退出并保存
</code></pre>
<p>执行<code>gdisk /dev/sdx</code>对sdx硬盘进行编辑，分区表编辑完成保存后，需要重新启动系统，否则系统内核还不知道硬盘分区已经改变了，这个时候你<code>ls /dev/sd*</code>查看到的分区情况还是编辑之前的。</p>
<h2 id="7-blkid-列出所有分区的uuid"><a href="#7-blkid-列出所有分区的uuid" class="headerlink" title="7.blkid 列出所有分区的uuid"></a>7.blkid 列出所有分区的uuid</h2><p>硬盘根据插拔接口顺序不同可能是sda，也可能是sdb，这样重启后会不能正确的挂载所有的硬盘，为解决这个问题，UUID被文件系统设计者采用，使其可以持久唯一标识一个硬盘分区。其实方式很简单，就是在文件系统的超级块中使用128位存放UUID。这个UUID是在使用文件系统格式化分区时计算生成的，例如Linux下的文件系统工具mkfs就在格式化分区的同时，生成UUID并把它记录到超级块的固定区域中。</p>
<p>使用mkfs对分区格式化后，会显示分区的uuid，如果我们没有记录下来后面怎么查呢，这个就要用到<code>blkid</code>工具了，他可以列出系统中所有硬盘分区的uuid。</p>
<h2 id="8-rsync-远程同步工具"><a href="#8-rsync-远程同步工具" class="headerlink" title="8.rsync 远程同步工具"></a>8.rsync 远程同步工具</h2><p>rsync 是一个常用的 Linux 应用程序，用于文件同步。</p>
<p>它可以在本地计算机与远程计算机之间，或者两个本地目录之间同步文件（但不支持两台远程计算机之间的同步）。它也可以当作文件复制工具，替代cp和mv命令。</p>
<p>它名称里面的r指的是 remote，rsync 其实就是”远程同步”（remote sync）的意思。与其他文件传输工具（如 FTP 或 scp）不同，rsync 的最大特点是会检查发送方和接收方已有的文件，仅传输有变动的部分（默认规则是文件大小或修改时间有变动）。</p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2020/08/rsync.html">用法参考文章</a></p>
<h3 id="r-参数"><a href="#r-参数" class="headerlink" title="-r 参数"></a>-r 参数</h3><p>本机使用 rsync 命令时，可以作为cp和mv命令的替代方法，将源目录同步到目标目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -r source destination</span><br></pre></td></tr></table></figure>

<p>上面命令中，-r表示递归，即包含子目录。注意，-r是必须的，否则 rsync 运行不会成功。source目录表示源目录，destination表示目标目录。</p>
<p>如果有多个文件或目录需要同步，可以写成下面这样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -r source1 source2 destination</span><br></pre></td></tr></table></figure>

<p>上面命令中，source1、source2都会被同步到destination目录。</p>
<h3 id="a-参数"><a href="#a-参数" class="headerlink" title="-a 参数"></a>-a 参数</h3><p>-a参数可以替代-r，除了可以递归同步以外，还可以同步元信息（比如修改时间、权限等）。由于 rsync 默认使用文件大小和修改时间决定文件是否需要更新，所以-a比-r更有用。下面的用法才是常见的写法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -a source destination</span><br></pre></td></tr></table></figure>

<p>目标目录destination如果不存在，rsync 会自动创建。执行上面的命令后，源目录source被完整地复制到了目标目录destination下面，即形成了destination&#x2F;source的目录结构。</p>
<p>如果只想同步源目录source里面的内容到目标目录destination，则需要在源目录后面加上斜杠。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -a source/ destination</span><br></pre></td></tr></table></figure>

<p>上面命令执行后，source目录里面的内容，就都被复制到了destination目录里面，并不会在destination下面创建一个source子目录。</p>
<h3 id="n-参数"><a href="#n-参数" class="headerlink" title="-n 参数"></a>-n 参数</h3><p>如果不确定 rsync 执行后会产生什么结果，可以先用-n或–dry-run参数模拟执行的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -anv source/ destination</span><br></pre></td></tr></table></figure>

<p>上面命令中，-n参数模拟命令执行的结果，并不真的执行命令。-v参数则是将结果输出到终端，这样就可以看到哪些内容会被同步。</p>
<h3 id="–delete-参数"><a href="#–delete-参数" class="headerlink" title="–delete 参数"></a>–delete 参数</h3><p>默认情况下，rsync 只确保源目录的所有内容（明确排除的文件除外）都复制到目标目录。它不会使两个目录保持相同，并且不会删除文件。如果要使得目标目录成为源目录的镜像副本，则必须使用–delete参数，这将删除只存在于目标目录、不存在于源目录的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --delete source/ destination</span><br></pre></td></tr></table></figure>

<p>上面命令中，–delete参数会使得destination成为source的一个镜像。</p>
<h3 id="–exclude-参数"><a href="#–exclude-参数" class="headerlink" title="–exclude 参数"></a>–exclude 参数</h3><p>有时，我们希望同步时排除某些文件或目录，这时可以用–exclude参数指定排除模式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --exclude=&#x27;*.txt&#x27; source/ destination</span><br><span class="line"># 或者</span><br><span class="line">$ rsync -av --exclude &#x27;*.txt&#x27; source/ destination</span><br></pre></td></tr></table></figure>

<p>上面命令排除了所有 TXT 文件。</p>
<p>注意，rsync 会同步以”点”开头的隐藏文件，如果要排除隐藏文件，可以这样写–exclude&#x3D;”.*”。</p>
<p>如果要排除某个目录里面的所有文件，但不希望排除目录本身，可以写成下面这样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --exclude &#x27;dir1/*&#x27; source/ destination</span><br></pre></td></tr></table></figure>

<p>多个排除模式，可以用多个–exclude参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --exclude &#x27;file1.txt&#x27; --exclude &#x27;dir1/*&#x27; source/ destination</span><br></pre></td></tr></table></figure>

<p>多个排除模式也可以利用 Bash 的大扩号的扩展功能，只用一个–exclude参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --exclude=&#123;&#x27;file1.txt&#x27;,&#x27;dir1/*&#x27;&#125; source/ destination</span><br></pre></td></tr></table></figure>

<p>如果排除模式很多，可以将它们写入一个文件，每个模式一行，然后用–exclude-from参数指定这个文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --exclude-from=&#x27;exclude-file.txt&#x27; source/ destination</span><br></pre></td></tr></table></figure>


<h3 id="–include-参数"><a href="#–include-参数" class="headerlink" title="–include 参数"></a>–include 参数</h3><p>–include参数用来指定必须同步的文件模式，往往与–exclude结合使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -av --include=&quot;*.txt&quot; --exclude=&#x27;*&#x27; source/ destination</span><br></pre></td></tr></table></figure>

<p>上面命令指定同步时，排除所有文件，但是会包括 TXT 文件。</p>
<h3 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份"></a>增量备份</h3><p>rsync 的最大特点就是它可以完成增量备份，也就是默认只复制有变动的文件。</p>
<p>除了源目录与目标目录直接比较，rsync 还支持使用基准目录，即将源目录与基准目录之间变动的部分，同步到目标目录。</p>
<p>具体做法是，第一次同步是全量备份，所有文件在基准目录里面同步一份。以后每一次同步都是增量备份，只同步源目录与基准目录之间有变动的部分，将这部分保存在一个新的目标目录。这个新的目标目录之中，也是包含所有文件，但实际上，只有那些变动过的文件是存在于该目录，其他没有变动的文件都是指向基准目录文件的硬链接。</p>
<p>–link-dest参数用来指定同步时的基准目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -a --delete --link-dest /compare/path /source/path /target/path</span><br></pre></td></tr></table></figure>

<p>上面命令中，–link-dest参数指定基准目录&#x2F;compare&#x2F;path，然后源目录&#x2F;source&#x2F;path跟基准目录进行比较，找出变动的文件，将它们拷贝到目标目录&#x2F;target&#x2F;path。那些没变动的文件则会生成硬链接。这个命令的第一次备份时是全量备份，后面就都是增量备份了。</p>
<p>下面是一个脚本示例，备份用户的主目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># A script to perform incremental backups using rsync</span><br><span class="line"></span><br><span class="line">set -o errexit</span><br><span class="line">set -o nounset</span><br><span class="line">set -o pipefail</span><br><span class="line"></span><br><span class="line">readonly SOURCE_DIR=&quot;$&#123;HOME&#125;&quot;</span><br><span class="line">readonly BACKUP_DIR=&quot;/mnt/data/backups&quot;</span><br><span class="line">readonly DATETIME=&quot;$(date &#x27;+%Y-%m-%d_%H:%M:%S&#x27;)&quot;</span><br><span class="line">readonly BACKUP_PATH=&quot;$&#123;BACKUP_DIR&#125;/$&#123;DATETIME&#125;&quot;</span><br><span class="line">readonly LATEST_LINK=&quot;$&#123;BACKUP_DIR&#125;/latest&quot;</span><br><span class="line"></span><br><span class="line">mkdir -p &quot;$&#123;BACKUP_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">rsync -av --delete \</span><br><span class="line">  &quot;$&#123;SOURCE_DIR&#125;/&quot; \</span><br><span class="line">  --link-dest &quot;$&#123;LATEST_LINK&#125;&quot; \</span><br><span class="line">  --exclude=&quot;.cache&quot; \</span><br><span class="line">  &quot;$&#123;BACKUP_PATH&#125;&quot;</span><br><span class="line"></span><br><span class="line">rm -rf &quot;$&#123;LATEST_LINK&#125;&quot;</span><br><span class="line">ln -s &quot;$&#123;BACKUP_PATH&#125;&quot; &quot;$&#123;LATEST_LINK&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>上面脚本中，每一次同步都会生成一个新目录<code>$&#123;BACKUP_DIR&#125;/$&#123;DATETIME&#125;</code>，并将软链接<code>$&#123;BACKUP_DIR&#125;/latest</code>指向这个目录。下一次备份时，就将<code>$&#123;BACKUP_DIR&#125;/latest</code>作为基准目录，生成新的备份目录。最后，再将软链接<code>$&#123;BACKUP_DIR&#125;/latest</code>指向新的备份目录。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-15T08:30:00.000Z" title="2023/8/15 16:30:00">2023-08-15</time>发表</span><span class="level-item"><time dateTime="2023-08-15T10:19:31.245Z" title="2023/8/15 18:19:31">2023-08-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Ubuntu2Nas/">Ubuntu2Nas</a></span><span class="level-item">16 分钟读完 (大约2330个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/15/Nas/nextcloud/">自建Nextcloud私有云盘</a></h1><div class="content"><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>从Nextcloud<a target="_blank" rel="noopener" href="https://nextcloud.com/">官方网站</a>下载server的安装包，复制到<code>/var/www</code>目录解压。</p>
<p>详细安装过程参考<a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/stable/admin_manual/installation/source_installation.html">官方文档</a></p>
<h3 id="1、按照官方文档安装完善php模块"><a href="#1、按照官方文档安装完善php模块" class="headerlink" title="1、按照官方文档安装完善php模块"></a>1、按照官方文档安装完善php模块</h3><p>必须要安装的模块</p>
<ul>
<li><p>PHP (see System requirements for a list of supported versions)</p>
</li>
<li><p>PHP module ctype</p>
</li>
<li><p>PHP module curl</p>
</li>
<li><p>PHP module dom</p>
</li>
<li><p>PHP module fileinfo (included with PHP)</p>
</li>
<li><p>PHP module filter (only on Mageia and FreeBSD)</p>
</li>
<li><p>PHP module GD</p>
</li>
<li><p>PHP module hash (only on FreeBSD)</p>
</li>
<li><p>PHP module JSON (included with PHP &gt;&#x3D; 8.0)</p>
</li>
<li><p>PHP module libxml (Linux package libxml2 must be &gt;&#x3D;2.7.0)</p>
</li>
<li><p>PHP module mbstring</p>
</li>
<li><p>PHP module openssl (included with PHP &gt;&#x3D; 8.0)</p>
</li>
<li><p>PHP module posix</p>
</li>
<li><p>PHP module session</p>
</li>
<li><p>PHP module SimpleXML</p>
</li>
<li><p>PHP module XMLReader</p>
</li>
<li><p>PHP module XMLWriter</p>
</li>
<li><p>PHP module zip</p>
</li>
<li><p>PHP module zlib</p>
</li>
</ul>
<p>选择合适的数据库模块：</p>
<ul>
<li><p>PHP module pdo_sqlite (&gt;&#x3D; 3, usually not recommended for performance reasons)</p>
</li>
<li><p>PHP module pdo_mysql (MySQL&#x2F;MariaDB)</p>
</li>
<li><p>PHP module pdo_pgsql (PostgreSQL)</p>
</li>
</ul>
<p>推荐安装的模块：</p>
<ul>
<li><p>PHP module bz2 (recommended, required for extraction of apps)</p>
</li>
<li><p>PHP module intl (increases language translation performance and fixes sorting of non-ASCII characters)</p>
</li>
</ul>
<h3 id="2、Apache配置文件"><a href="#2、Apache配置文件" class="headerlink" title="2、Apache配置文件"></a>2、Apache配置文件</h3><p>新增配置文件<code>vim /etc/apache2/sites-available/nextcloud.conf</code>，复制以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">  DocumentRoot /var/www/nextcloud/</span><br><span class="line">  ServerName  your.server.com</span><br><span class="line"></span><br><span class="line">  &lt;Directory /var/www/nextcloud/&gt;</span><br><span class="line">    Require all granted</span><br><span class="line">    AllowOverride All</span><br><span class="line">    Options FollowSymLinks MultiViews</span><br><span class="line"></span><br><span class="line">    &lt;IfModule mod_dav.c&gt;</span><br><span class="line">      Dav off</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">  &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>保存，然后运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a2ensite nextcloud.conf</span><br></pre></td></tr></table></figure>

<p>启用必要的Apache模块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a2enmod rewrite</span><br><span class="line"></span><br><span class="line">a2enmod headers</span><br><span class="line">a2enmod env</span><br><span class="line">a2enmod dir</span><br><span class="line">a2enmod mime</span><br></pre></td></tr></table></figure>

<p>If you’re running mod_fcgi instead of the standard mod_php also enable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a2enmod setenvif</span><br></pre></td></tr></table></figure>

<p>最后重启Apache：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service apache2 restart</span><br></pre></td></tr></table></figure>

<p>现在就可以访问<code>http://your.server.com</code>安装Nextcloud。</p>
<h2 id="Redis缓存配置"><a href="#Redis缓存配置" class="headerlink" title="Redis缓存配置"></a>Redis缓存配置</h2><p>修改配置文件<code>nextcloud/config/config.php</code>：</p>
<h3 id="Small-x2F-Private-home-server"><a href="#Small-x2F-Private-home-server" class="headerlink" title="Small&#x2F;Private home server"></a>Small&#x2F;Private home server</h3><p>Only use APCu:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;memcache.local&#x27; =&gt; &#x27;\OC\Memcache\APCu&#x27;,</span><br></pre></td></tr></table></figure>

<h3 id="Organizations-with-single-server"><a href="#Organizations-with-single-server" class="headerlink" title="Organizations with single-server"></a>Organizations with single-server</h3><p>Use Redis for everything except local memcache:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x27;memcache.local&#x27; =&gt; &#x27;\OC\Memcache\APCu&#x27;,</span><br><span class="line">&#x27;memcache.distributed&#x27; =&gt; &#x27;\OC\Memcache\Redis&#x27;,</span><br><span class="line">&#x27;memcache.locking&#x27; =&gt; &#x27;\OC\Memcache\Redis&#x27;,</span><br><span class="line">&#x27;redis&#x27; =&gt; [</span><br><span class="line">     &#x27;host&#x27; =&gt; &#x27;localhost&#x27;,</span><br><span class="line">     &#x27;port&#x27; =&gt; 6379,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<h3 id="Organizations-with-clustered-setups"><a href="#Organizations-with-clustered-setups" class="headerlink" title="Organizations with clustered setups"></a>Organizations with clustered setups</h3><p>Use APCu for local cache and either Redis cluster …:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27;memcache.local&#x27; =&gt; &#x27;\OC\Memcache\APCu&#x27;,</span><br><span class="line">&#x27;memcache.distributed&#x27; =&gt; &#x27;\OC\Memcache\Redis&#x27;,</span><br><span class="line">&#x27;memcache.locking&#x27; =&gt; &#x27;\OC\Memcache\Redis&#x27;,</span><br><span class="line">&#x27;redis.cluster&#x27; =&gt; [</span><br><span class="line">    &#x27;seeds&#x27; =&gt; [ // provide some/all of the cluster servers to bootstrap discovery, port required</span><br><span class="line">       &#x27;cache-cluster:7000&#x27;,</span><br><span class="line">       &#x27;cache-cluster:7001&#x27;,</span><br><span class="line">    ],</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>APCu is disabled by default on CLI which could cause issues with nextcloud’s cron jobs. Please make sure you set the <code>apc.enable_cli</code> to <code>1</code> on your <code>php.ini</code> config file or append <code>--define apc.enable_cli=1</code> to the cron job call.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/php/8.1/cli/php.ini</span><br></pre></td></tr></table></figure>

<p>在末尾添加<code>apc.enable_cli=1</code>，否则当你运行occ命令的时候也会提示你APCu不可用。</p>
<h2 id="OCC命令的使用"><a href="#OCC命令的使用" class="headerlink" title="OCC命令的使用"></a>OCC命令的使用</h2><p>直接运行<code>occ</code>命令，不带任何选项，就会列出occ命令的所有可用的选项和用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u www-data php8.1 /var/www/nextcloud/occ</span><br></pre></td></tr></table></figure>

<p>返回信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">Nextcloud 24.0.12</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  command [options] [arguments]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            Display this help message</span><br><span class="line">  -q, --quiet           Do not output any message</span><br><span class="line">  -V, --version         Display this application version</span><br><span class="line">      --ansi            Force ANSI output</span><br><span class="line">      --no-ansi         Disable ANSI output</span><br><span class="line">  -n, --no-interaction  Do not ask any interactive question</span><br><span class="line">      --no-warnings     Skip global warnings, show command output only</span><br><span class="line">  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug</span><br><span class="line"></span><br><span class="line">Available commands:</span><br><span class="line">  check                                  check dependencies of the server environment</span><br><span class="line">  help                                   Display help for a command</span><br><span class="line">  list                                   List commands</span><br><span class="line">  status                                 show some status information</span><br><span class="line">  upgrade                                run upgrade routines after installation of a new release. The release has to be installed before.</span><br><span class="line"> activity</span><br><span class="line">  activity:send-mails                    Sends the activity notification mails</span><br><span class="line"> app</span><br><span class="line">  app:check-code                         check code to be compliant</span><br><span class="line">  app:disable                            disable an app</span><br><span class="line">  app:enable                             enable an app</span><br><span class="line">  app:getpath                            Get an absolute path to the app directory</span><br><span class="line">  app:install                            install an app</span><br><span class="line">  app:list                               List all available apps</span><br><span class="line">  app:remove                             remove an app</span><br><span class="line">  app:update                             update an app or all apps</span><br><span class="line"> background</span><br><span class="line">  background:ajax                        Use ajax to run background jobs</span><br><span class="line">  background:cron                        Use cron to run background jobs</span><br><span class="line">  background:webcron                     Use webcron to run background jobs</span><br><span class="line"> background-job</span><br><span class="line">  background-job:execute                 Execute a single background job manually</span><br><span class="line"> broadcast</span><br><span class="line">  broadcast:test                         test the SSE broadcaster</span><br><span class="line"> circles</span><br><span class="line">  circles:check                          Checking your configuration</span><br><span class="line">  circles:maintenance                    Clean stuff, keeps the app running</span><br><span class="line">  circles:manage:config                  edit config/type of a Circle</span><br><span class="line">  circles:manage:create                  create a new circle</span><br><span class="line">  circles:manage:destroy                 destroy a circle by its ID</span><br><span class="line">  circles:manage:details                 get details about a circle by its ID</span><br><span class="line">  circles:manage:edit                    edit displayName or description of a Circle</span><br><span class="line">  circles:manage:join                    emulate a user joining a Circle</span><br><span class="line">  circles:manage:leave                   simulate a user joining a Circle</span><br><span class="line">  circles:manage:list                    listing current circles</span><br><span class="line">  circles:manage:setting                 edit setting for a Circle</span><br><span class="line">  circles:members:add                    Add a member to a Circle</span><br><span class="line">  circles:members:details                get details about a member by its ID</span><br><span class="line">  circles:members:level                  Change the level of a member from a Circle</span><br><span class="line">  circles:members:list                   listing Members from a Circle</span><br><span class="line">  circles:members:remove                 remove a member from a circle</span><br><span class="line">  circles:members:search                 Change the level of a member from a Circle</span><br><span class="line">  circles:memberships                    index and display memberships for local and federated users</span><br><span class="line">  circles:remote                         remote features</span><br><span class="line">  circles:shares:files                   listing shares files</span><br><span class="line">  circles:sync                           Sync Circles and Members</span><br><span class="line">  circles:test                           testing some features</span><br><span class="line"> config</span><br><span class="line">  config:app:delete                      Delete an app config value</span><br><span class="line">  config:app:get                         Get an app config value</span><br><span class="line">  config:app:set                         Set an app config value</span><br><span class="line">  config:import                          Import a list of configs</span><br><span class="line">  config:list                            List all configs</span><br><span class="line">  config:system:delete                   Delete a system config value</span><br><span class="line">  config:system:get                      Get a system config value</span><br><span class="line">  config:system:set                      Set a system config value</span><br><span class="line"> dav</span><br><span class="line">  dav:create-addressbook                 Create a dav addressbook</span><br><span class="line">  dav:create-calendar                    Create a dav calendar</span><br><span class="line">  dav:delete-calendar                    Delete a dav calendar</span><br><span class="line">  dav:list-calendars                     List all calendars of a user</span><br><span class="line">  dav:move-calendar                      Move a calendar from an user to another</span><br><span class="line">  dav:remove-invalid-shares              Remove invalid dav shares</span><br><span class="line">  dav:retention:clean-up                 </span><br><span class="line">  dav:send-event-reminders               Sends event reminders</span><br><span class="line">  dav:sync-birthday-calendar             Synchronizes the birthday calendar</span><br><span class="line">  dav:sync-system-addressbook            Synchronizes users to the system addressbook</span><br><span class="line"> db</span><br><span class="line">  db:add-missing-columns                 Add missing optional columns to the database tables</span><br><span class="line">  db:add-missing-indices                 Add missing indices to the database tables</span><br><span class="line">  db:add-missing-primary-keys            Add missing primary keys to the database tables</span><br><span class="line">  db:convert-filecache-bigint            Convert the ID columns of the filecache to BigInt</span><br><span class="line">  db:convert-mysql-charset               Convert charset of MySQL/MariaDB to use utf8mb4</span><br><span class="line">  db:convert-type                        Convert the Nextcloud database to the newly configured one</span><br><span class="line"> encryption</span><br><span class="line">  encryption:change-key-storage-root     Change key storage root</span><br><span class="line">  encryption:decrypt-all                 Disable server-side encryption and decrypt all files</span><br><span class="line">  encryption:disable                     Disable encryption</span><br><span class="line">  encryption:enable                      Enable encryption</span><br><span class="line">  encryption:encrypt-all                 Encrypt all files for all users</span><br><span class="line">  encryption:list-modules                List all available encryption modules</span><br><span class="line">  encryption:migrate-key-storage-format  Migrate the format of the keystorage to a newer format</span><br><span class="line">  encryption:set-default-module          Set the encryption default module</span><br><span class="line">  encryption:show-key-storage-root       Show current key storage root</span><br><span class="line">  encryption:status                      Lists the current status of encryption</span><br><span class="line"> federation</span><br><span class="line">  federation:sync-addressbooks           Synchronizes addressbooks of all federated clouds</span><br><span class="line"> files</span><br><span class="line">  files:cleanup                          cleanup filecache</span><br><span class="line">  files:recommendations:recommend        </span><br><span class="line">  files:repair-tree                      Try and repair malformed filesystem tree structures</span><br><span class="line">  files:scan                             rescan filesystem</span><br><span class="line">  files:scan-app-data                    rescan the AppData folder</span><br><span class="line">  files:transfer-ownership               All files and folders are moved to another user - outgoing shares and incoming user file shares (optionally) are moved as well.</span><br><span class="line"> files_external</span><br><span class="line">  files_external:applicable              Manage applicable users and groups for a mount</span><br><span class="line">  files_external:backends                Show available authentication and storage backends</span><br><span class="line">  files_external:config                  Manage backend configuration for a mount</span><br><span class="line">  files_external:create                  Create a new mount configuration</span><br><span class="line">  files_external:delete                  Delete an external mount</span><br><span class="line">  files_external:export                  Export mount configurations</span><br><span class="line">  files_external:import                  Import mount configurations</span><br><span class="line">  files_external:list                    List configured admin or personal mounts</span><br><span class="line">  files_external:notify                  Listen for active update notifications for a configured external mount</span><br><span class="line">  files_external:option                  Manage mount options for a mount</span><br><span class="line">  files_external:verify                  Verify mount configuration</span><br><span class="line"> group</span><br><span class="line">  group:add                              Add a group</span><br><span class="line">  group:adduser                          add a user to a group</span><br><span class="line">  group:delete                           Remove a group</span><br><span class="line">  group:info                             Show information about a group</span><br><span class="line">  group:list                             list configured groups</span><br><span class="line">  group:removeuser                       remove a user from a group</span><br><span class="line"> integrity</span><br><span class="line">  integrity:check-app                    Check integrity of an app using a signature.</span><br><span class="line">  integrity:check-core                   Check integrity of core code using a signature.</span><br><span class="line">  integrity:sign-app                     Signs an app using a private key.</span><br><span class="line">  integrity:sign-core                    Sign core using a private key.</span><br><span class="line"> l10n</span><br><span class="line">  l10n:createjs                          Create javascript translation files for a given app</span><br><span class="line"> log</span><br><span class="line">  log:file                               manipulate logging backend</span><br><span class="line">  log:manage                             manage logging configuration</span><br><span class="line">  log:tail                               Tail the nextcloud logfile</span><br><span class="line">  log:watch                              Watch the nextcloud logfile</span><br><span class="line"> maintenance</span><br><span class="line">  maintenance:data-fingerprint           update the systems data-fingerprint after a backup is restored</span><br><span class="line">  maintenance:mimetype:update-db         Update database mimetypes and update filecache</span><br><span class="line">  maintenance:mimetype:update-js         Update mimetypelist.js</span><br><span class="line">  maintenance:mode                       set maintenance mode</span><br><span class="line">  maintenance:repair                     repair this installation</span><br><span class="line">  maintenance:repair-share-owner         repair invalid share-owner entries in the database</span><br><span class="line">  maintenance:theme:update               Apply custom theme changes</span><br><span class="line">  maintenance:update:htaccess            Updates the .htaccess file</span><br><span class="line"> notification</span><br><span class="line">  notification:generate                  Generate a notification for the given user</span><br><span class="line">  notification:test-push                 Generate a notification for the given user</span><br><span class="line"> preview</span><br><span class="line">  preview:repair                         distributes the existing previews into subfolders</span><br><span class="line">  preview:reset-rendered-texts           Deletes all generated avatars and previews of text and md files</span><br><span class="line"> security</span><br><span class="line">  security:bruteforce:reset              resets bruteforce attemps for given IP address</span><br><span class="line">  security:certificates                  list trusted certificates</span><br><span class="line">  security:certificates:import           import trusted certificate in PEM format</span><br><span class="line">  security:certificates:remove           remove trusted certificate</span><br><span class="line"> serverinfo</span><br><span class="line">  serverinfo:update-storage-statistics   Triggers an update of the counts related to storages used in serverinfo</span><br><span class="line"> sharing</span><br><span class="line">  sharing:cleanup-remote-storages        Cleanup shared storage entries that have no matching entry in the shares_external table</span><br><span class="line">  sharing:expiration-notification        Notify share initiators when a share will expire the next day.</span><br><span class="line"> support</span><br><span class="line">  support:report                         Generate a system report</span><br><span class="line"> tag</span><br><span class="line">  tag:add                                Add new tag</span><br><span class="line">  tag:delete                             delete a tag</span><br><span class="line">  tag:edit                               edit tag attributes</span><br><span class="line">  tag:list                               list tags</span><br><span class="line"> text</span><br><span class="line">  text:reset                             Reset a text document</span><br><span class="line"> theming</span><br><span class="line">  theming:config                         Set theming app config values</span><br><span class="line"> trashbin</span><br><span class="line">  trashbin:cleanup                       Remove deleted files</span><br><span class="line">  trashbin:expire                        Expires the users trashbin</span><br><span class="line">  trashbin:restore                       Restore all deleted files</span><br><span class="line">  trashbin:size                          Configure the target trashbin size</span><br><span class="line"> twofactorauth</span><br><span class="line">  twofactorauth:cleanup                  Clean up the two-factor user-provider association of an uninstalled/removed provider</span><br><span class="line">  twofactorauth:disable                  Disable two-factor authentication for a user</span><br><span class="line">  twofactorauth:enable                   Enable two-factor authentication for a user</span><br><span class="line">  twofactorauth:enforce                  Enabled/disable enforced two-factor authentication</span><br><span class="line">  twofactorauth:state                    Get the two-factor authentication (2FA) state of a user</span><br><span class="line"> update</span><br><span class="line">  update:check                           Check for server and app updates</span><br><span class="line"> user</span><br><span class="line">  user:add                               adds a user</span><br><span class="line">  user:add-app-password                  Add app password for the named user</span><br><span class="line">  user:delete                            deletes the specified user</span><br><span class="line">  user:disable                           disables the specified user</span><br><span class="line">  user:enable                            enables the specified user</span><br><span class="line">  user:info                              show user info</span><br><span class="line">  user:lastseen                          shows when the user was logged in last time</span><br><span class="line">  user:list                              list configured users</span><br><span class="line">  user:report                            shows how many users have access</span><br><span class="line">  user:resetpassword                     Resets the password of the named user</span><br><span class="line">  user:setting                           Read and modify user settings</span><br><span class="line"> versions</span><br><span class="line">  versions:cleanup                       Delete versions</span><br><span class="line">  versions:expire                        Expires the users file versions</span><br><span class="line"> workflows</span><br><span class="line">  workflows:list                         Lists configured workflows</span><br></pre></td></tr></table></figure>

<p>扫描所有用户文件更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u www-data php8.1 /var/www/nextcloud/occ files:scan --all</span><br></pre></td></tr></table></figure>

<p>扫描特定用户文件更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u www-data php8.1 /var/www/nextcloud/occ files:scan username</span><br></pre></td></tr></table></figure>

<p>扫描特定目录文件更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u www-data php8.1 /var/www/nextcloud/occ files:scan --path=/path/to/scan</span><br></pre></td></tr></table></figure>

<h2 id="后台服务优化"><a href="#后台服务优化" class="headerlink" title="后台服务优化"></a>后台服务优化</h2><p>后台服务有三种方式：AJAX，Webcron，Cron</p>
<p>systemd</p>
<p>If systemd is installed on the system, a systemd timer could be an alternative to a cronjob.</p>
<p>This approach requires two files: <code>nextcloudcron.service</code> and <code>nextcloudcron.timer</code>. Create these two files in <code>/etc/systemd/system/</code>.</p>
<p><strong>nextcloudcron.service</strong> should look like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Nextcloud cron.php job</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=www-data</span><br><span class="line">ExecStart=/usr/bin/php -f /var/www/nextcloud/cron.php</span><br><span class="line">KillMode=process</span><br></pre></td></tr></table></figure>

<p>Replace the user <code>www-data</code> with the user of your http server and <code>/var/www/nextcloud/cron.php</code> with the location of <code>cron.php</code> in your nextcloud directory.</p>
<p>The <code>KillMode=process</code> setting is necessary for external programs that are started by the cron job to keep running after the cron job has finished.</p>
<p>Note that the <strong>.service</strong> unit file does not need an <code>[Install]</code> section. Please check your setup because we recommended it in earlier versions of this admin manual.</p>
<p><strong>nextcloudcron.timer</strong> should look like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Run Nextcloud cron.php every 5 minutes</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">OnBootSec=5min</span><br><span class="line">OnUnitActiveSec=5min</span><br><span class="line">Unit=nextcloudcron.service</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=timers.target</span><br></pre></td></tr></table></figure>

<p>The important parts in the timer-unit are <code>OnBootSec</code> and <code>OnUnitActiveSec</code>. <code>OnBootSec</code> will start the timer 5 minutes after boot, otherwise you would have to start it manually after every boot. <code>OnUnitActiveSec</code> will set a 5 minute timer after the service-unit was last activated.</p>
<p>Now all that is left is to start and enable the timer by running this command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now nextcloudcron.timer</span><br></pre></td></tr></table></figure>

<p>When the option <code>--now</code> is used with <code>enable</code>, the respective unit will also be started.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-14T04:10:00.000Z" title="2023/8/14 12:10:00">2023-08-14</time>发表</span><span class="level-item"><time dateTime="2023-08-21T14:08:46.407Z" title="2023/8/21 22:08:46">2023-08-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a></span><span class="level-item">11 分钟读完 (大约1719个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/14/windows-office-kms/">Microsoft Office及Windows的KMS激活步骤</a></h1><div class="content"><h2 id="Docker-部署KMS-服务器"><a href="#Docker-部署KMS-服务器" class="headerlink" title="Docker 部署KMS 服务器"></a>Docker 部署KMS 服务器</h2><p>Docker镜像地址： <a target="_blank" rel="noopener" href="https://hub.docker.com/r/mogeko/vlmcsd">https://hub.docker.com/r/mogeko/vlmcsd</a></p>
<p>此程序的单独地址： <a target="_blank" rel="noopener" href="https://github.com/Wind4/vlmcsd">https://github.com/Wind4/vlmcsd</a></p>
<p>部署KMS服务器，使用Docker ，端口为 1688。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker run -d -p 1688:1688 --restart=always --name vlmcsd mikolatero/vlmcsd</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker logs vlmcsd</span><br><span class="line"></span><br><span class="line">2019-07-27 08:14:00: Listening on [::]:1688</span><br><span class="line"></span><br><span class="line">2019-07-27 08:14:00: Listening on 0.0.0.0:1688</span><br><span class="line"></span><br><span class="line">2019-07-27 08:14:00: vlmcsd svn1112-2-gf1a3c7f, built 2019-07-26 18:11:51 UTC started successfully</span><br></pre></td></tr></table></figure>

<p>查看日志，确定正常工作。</p>
<h2 id="Microsoft-Office-KMS激活步骤："><a href="#Microsoft-Office-KMS激活步骤：" class="headerlink" title="Microsoft Office KMS激活步骤："></a>Microsoft Office KMS激活步骤：</h2><ol>
<li>以管理员用户打开命令行工具；</li>
<li>切换到office的安装目录，例如office2016安装路径为<code>C:\\Program Files\\Microsoft Office\\Office16</code>；</li>
<li>设置kms服务器：<code>cscript ospp.vbs /sethst:[kms.03k.org](http://kms.03k.org)</code>，返回信息；</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---Processing--------------------------</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">Successfully applied setting.</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">---Exiting-----------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>激活office：`cscript ospp.vbs &#x2F;act`。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">---Processing--------------------------</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">Installed product key detected - attempting to activate the following product:</span><br><span class="line"></span><br><span class="line">SKU ID: d450596f-894d-49e0-966a-fd39ed4c4c64</span><br><span class="line"></span><br><span class="line">LICENSE NAME: Office 16, Office16ProPlusVL_KMS_Client edition</span><br><span class="line"></span><br><span class="line">LICENSE DESCRIPTION: Office 16, VOLUME_KMSCLIENT channel</span><br><span class="line"></span><br><span class="line">Last 5 characters of installed product key: WFG99</span><br><span class="line"></span><br><span class="line">&lt;Product activation successful&gt;</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">---Exiting-----------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Microsoft-Windows-KMS激活步骤："><a href="#Microsoft-Windows-KMS激活步骤：" class="headerlink" title="Microsoft Windows KMS激活步骤："></a>Microsoft Windows KMS激活步骤：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 卸载已安装密钥</span><br><span class="line">slmgr.vbs /upk</span><br><span class="line"></span><br><span class="line"># 安装需要激活的版本密钥</span><br><span class="line"># 这里以专业版为例，Windows 10 和 11 通用</span><br><span class="line"># 更多版本的系统密钥见下文</span><br><span class="line">slmgr /ipk W269N-WFGWX-YVC9B-4J6C9-T83GX</span><br><span class="line"></span><br><span class="line"># 设置 KMS 激活服务器</span><br><span class="line"># 请将 192.168.7.186 替换为实际 KMS 服务器网址或 IP</span><br><span class="line">slmgr /skms 192.168.7.186</span><br><span class="line"></span><br><span class="line"># 激活</span><br><span class="line">slmgr /ato</span><br></pre></td></tr></table></figure>


<h2 id="所有WINDOWS版本的GVLK密钥对照表"><a href="#所有WINDOWS版本的GVLK密钥对照表" class="headerlink" title="所有WINDOWS版本的GVLK密钥对照表"></a>所有WINDOWS版本的GVLK密钥对照表</h2><p>最新的参看<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-server/get-started/kms-client-activation-keys">微软官方网站</a></p>
<p>GVLK密钥是专门用于KMS激活的密钥，如果想使用KMS激活，那么必须先将系统的KEY替换为对应版本的GVLK密钥。</p>
<p>KMS不仅可以激活Windows 8、Windows 8.1和Windows 7、Windows 10这类我们常用的系统，还可以激活各种版本的Windows Server系统。</p>
<p>以下是GVLK密钥版本对照表，可配合KMS服务器进行使用。</p>
<h3 id="WINDOWS-SERVER-半年频道版本"><a href="#WINDOWS-SERVER-半年频道版本" class="headerlink" title="WINDOWS SERVER 半年频道版本"></a>WINDOWS SERVER 半年频道版本</h3><h4 id="Windows-Server-版本-1909、版本1903-和版本-1809"><a href="#Windows-Server-版本-1909、版本1903-和版本-1809" class="headerlink" title="Windows Server 版本 1909、版本1903 和版本 1809"></a>Windows Server 版本 1909、版本1903 和版本 1809</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server Datacenter</td>
<td>6NMRW-2C8FM-D24W7-TQWMY-CWH2D</td>
</tr>
<tr>
<td>Windows Server Standard</td>
<td>N2KJX-J94YW-TQVFB-DG9YT-724CC</td>
</tr>
</tbody></table>
<h3 id="WINDOWS-SERVER-LTSC-x2F-LTSB-版本"><a href="#WINDOWS-SERVER-LTSC-x2F-LTSB-版本" class="headerlink" title="WINDOWS SERVER LTSC&#x2F;LTSB 版本"></a>WINDOWS SERVER LTSC&#x2F;LTSB 版本</h3><h4 id="Windows-Server-2019"><a href="#Windows-Server-2019" class="headerlink" title="Windows Server 2019"></a>Windows Server 2019</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server 2019 Datacenter</td>
<td>WMDGN-G9PQG-XVVXX-R3X43-63DFG</td>
</tr>
<tr>
<td>Windows Server 2019 Standard</td>
<td>N69G4-B89J2-4G8F4-WWYCC-J464C</td>
</tr>
<tr>
<td>Windows Server 2019 Essentials</td>
<td>WVDHN-86M7X-466P6-VHXV7-YY726</td>
</tr>
</tbody></table>
<h4 id="Windows-Server-2016"><a href="#Windows-Server-2016" class="headerlink" title="Windows Server 2016"></a>Windows Server 2016</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server 2016 Datacenter</td>
<td>CB7KF-BWN84-R7R2Y-793K2-8XDDG</td>
</tr>
<tr>
<td>Windows Server 2016 Standard</td>
<td>WC2BQ-8NRM3-FDDYY-2BFGV-KHKQY</td>
</tr>
<tr>
<td>Windows Server 2016 Essentials</td>
<td>JCKRF-N37P4-C2D82-9YXRT-4M63B</td>
</tr>
</tbody></table>
<h3 id="WINDOWS-10，所有支持的半年频道版本"><a href="#WINDOWS-10，所有支持的半年频道版本" class="headerlink" title="WINDOWS 10，所有支持的半年频道版本"></a>WINDOWS 10，所有支持的半年频道版本</h3><p>有关受支持的版本和服务终止日期的信息，请参阅 Windows 生命周期情况说明书。</p>
<table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 10 专业版</td>
<td>W269N-WFGWX-YVC9B-4J6C9-T83GX</td>
</tr>
<tr>
<td>Windows 10 专业版 N</td>
<td>MH37W-N47XK-V7XM9-C7227-GCQG9</td>
</tr>
<tr>
<td>Windows 10 专业工作站版</td>
<td>NRG8B-VKK3Q-CXVCJ-9G2XF-6Q84J</td>
</tr>
<tr>
<td>Windows 10 专业工作站版 N</td>
<td>9FNHH-K3HBT-3W4TD-6383H-6XYWF</td>
</tr>
<tr>
<td>Windows 10 专业教育版</td>
<td>6TP4R-GNPTD-KYYHQ-7B7DP-J447Y</td>
</tr>
<tr>
<td>Windows 10 专业教育版 N</td>
<td>YVWGF-BXNMC-HTQYQ-CPQ99-66QFC</td>
</tr>
<tr>
<td>Windows 10 教育版</td>
<td>NW6C2-QMPVW-D7KKK-3GKT6-VCFB2</td>
</tr>
<tr>
<td>Windows 10 教育版 N</td>
<td>2WH4N-8QGBV-H22JP-CT43Q-MDWWJ</td>
</tr>
<tr>
<td>Windows 10 企业版</td>
<td>NPPR9-FWDCX-D2C8J-H872K-2YT43</td>
</tr>
<tr>
<td>Windows 10 企业版 N</td>
<td>DPH2V-TTNVB-4X9Q3-TJR4H-KHJW4</td>
</tr>
<tr>
<td>Windows 10 企业版 G</td>
<td>YYVX9-NTFWV-6MDM3-9PT4T-4M68B</td>
</tr>
<tr>
<td>Windows 10 企业版 G N</td>
<td>44RPN-FTY23-9VTTB-MP9BX-T84FV</td>
</tr>
</tbody></table>
<h3 id="WINDOWS-10-LTSC-x2F-LTSB-版本"><a href="#WINDOWS-10-LTSC-x2F-LTSB-版本" class="headerlink" title="WINDOWS 10 LTSC&#x2F;LTSB 版本"></a>WINDOWS 10 LTSC&#x2F;LTSB 版本</h3><h4 id="Windows-10-LTSC-2019"><a href="#Windows-10-LTSC-2019" class="headerlink" title="Windows 10 LTSC 2019"></a>Windows 10 LTSC 2019</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 10 企业版 LTSC 2019</td>
<td>M7XTQ-FN8P6-TTKYV-9D4CC-J462D</td>
</tr>
<tr>
<td>Windows 10 企业版 N LTSC 2019</td>
<td>92NFX-8DJQP-P6BBQ-THF9C-7CG2H</td>
</tr>
</tbody></table>
<h4 id="Windows-10-LTSB-2016"><a href="#Windows-10-LTSB-2016" class="headerlink" title="Windows 10 LTSB 2016"></a>Windows 10 LTSB 2016</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 10 企业版 LTSB 2016</td>
<td>DCPHK-NFMTC-H88MJ-PFHPY-QJ4BJ</td>
</tr>
<tr>
<td>Windows 10 企业版 N LTSB 2016</td>
<td>QFFDN-GRT3P-VKWWX-X7T3R-8B639</td>
</tr>
</tbody></table>
<h4 id="Windows-10-LTSB-2015"><a href="#Windows-10-LTSB-2015" class="headerlink" title="Windows 10 LTSB 2015"></a>Windows 10 LTSB 2015</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 10 企业版 2015 LTSB</td>
<td>WNMTR-4C88C-JK8YV-HQ7T2-76DF9</td>
</tr>
<tr>
<td>Windows 10 企业版 2015 LTSB N</td>
<td>2F77B-TNFGY-69QQF-B8YKP-D69TJ</td>
</tr>
</tbody></table>
<h3 id="早期版本的-WINDOWS-SERVER"><a href="#早期版本的-WINDOWS-SERVER" class="headerlink" title="早期版本的 WINDOWS SERVER"></a>早期版本的 WINDOWS SERVER</h3><h4 id="Windows-Server-版本-1803"><a href="#Windows-Server-版本-1803" class="headerlink" title="Windows Server 版本 1803"></a>Windows Server 版本 1803</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server Datacenter</td>
<td>2HXDN-KRXHB-GPYC7-YCKFJ-7FVDG</td>
</tr>
<tr>
<td>Windows Server Standard</td>
<td>PTXN8-JFHJM-4WC78-MPCBR-9W4KR</td>
</tr>
</tbody></table>
<h4 id="Windows-Server-版本-1709"><a href="#Windows-Server-版本-1709" class="headerlink" title="Windows Server 版本 1709"></a>Windows Server 版本 1709</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server Datacenter</td>
<td>6Y6KB-N82V8-D8CQV-23MJW-BWTG6</td>
</tr>
<tr>
<td>Windows Server Standard</td>
<td>DPCNP-XQFKJ-BJF7R-FRC8D-GF6G4</td>
</tr>
</tbody></table>
<h4 id="Windows-Server-2012-R2"><a href="#Windows-Server-2012-R2" class="headerlink" title="Windows Server 2012 R2"></a>Windows Server 2012 R2</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server 2012 R2 Server Standard</td>
<td>D2N9P-3P6X9-2R39C-7RTCD-MDVJX</td>
</tr>
<tr>
<td>Windows Server 2012 R2 Datacenter</td>
<td>W3GGN-FT8W3-Y4M27-J84CP-Q3VJ9</td>
</tr>
<tr>
<td>Windows Server 2012 R2 Essentials</td>
<td>KNC87-3J2TX-XB4WP-VCPJV-M4FWM</td>
</tr>
</tbody></table>
<h4 id="Windows-Server-2012"><a href="#Windows-Server-2012" class="headerlink" title="Windows Server 2012"></a>Windows Server 2012</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server 2012</td>
<td>BN3D2-R7TKB-3YPBD-8DRP2-27GG4</td>
</tr>
<tr>
<td>Windows Server 2012 N</td>
<td>8N2M2-HWPGY-7PGT9-HGDD8-GVGGY</td>
</tr>
<tr>
<td>Windows Server 2012 单语言版</td>
<td>2WN2H-YGCQR-KFX6K-CD6TF-84YXQ</td>
</tr>
<tr>
<td>Windows Server 2012 特定国家&#x2F;地区版</td>
<td>4K36P-JN4VD-GDC6V-KDT89-DYFKP</td>
</tr>
<tr>
<td>Windows Server 2012 Server 标准版</td>
<td>XC9B7-NBPP2-83J2H-RHMBY-92BT4</td>
</tr>
<tr>
<td>Windows Server 2012 MultiPoint 标准版</td>
<td>HM7DN-YVMH3-46JC3-XYTG7-CYQJJ</td>
</tr>
<tr>
<td>Windows Server 2012 MultiPoint 高级版</td>
<td>XNH6W-2V9GX-RGJ4K-Y8X6F-QGJ2G</td>
</tr>
<tr>
<td>Windows Server 2012 Datacenter</td>
<td>48HP8-DN98B-MYWDG-T2DCC-8W83P</td>
</tr>
</tbody></table>
<h4 id="Windows-Server-2008-R2"><a href="#Windows-Server-2008-R2" class="headerlink" title="Windows Server 2008 R2"></a>Windows Server 2008 R2</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server 2008 R2 Web 版</td>
<td>6TPJF-RBVHG-WBW2R-86QPH-6RTM4</td>
</tr>
<tr>
<td>Windows Server 2008 R2 HPC 版</td>
<td>TT8MH-CG224-D3D7Q-498W2-9QCTX</td>
</tr>
<tr>
<td>Windows Server 2008 R2 标准版</td>
<td>YC6KT-GKW9T-YTKYR-T4X34-R7VHC</td>
</tr>
<tr>
<td>Windows Server 2008 R2 企业版</td>
<td>489J6-VHDMP-X63PK-3K798-CPX3Y</td>
</tr>
<tr>
<td>Windows Server 2008 R2 Datacenter</td>
<td>74YFP-3QFB3-KQT8W-PMXWJ-7M648</td>
</tr>
<tr>
<td>面向基于 Itanium 系统的 Windows Server 2008 R2</td>
<td>GT63C-RJFQ3-4GMB6-BRFB9-CB83V</td>
</tr>
</tbody></table>
<h4 id="Windows-2008-Server"><a href="#Windows-2008-Server" class="headerlink" title="Windows 2008 Server"></a>Windows 2008 Server</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Web Server 2008</td>
<td>WYR28-R7TFJ-3X2YQ-YCY4H-M249D</td>
</tr>
<tr>
<td>Windows Server 2008 标准版</td>
<td>TM24T-X9RMF-VWXK6-X8JC9-BFGM2</td>
</tr>
<tr>
<td>不带 Hyper-V 的 Windows Server 2008 标准版</td>
<td>W7VD6-7JFBR-RX26B-YKQ3Y-6FFFJ</td>
</tr>
<tr>
<td>Windows Server 2008 企业版</td>
<td>YQGMW-MPWTJ-34KDK-48M3W-X4Q6V</td>
</tr>
<tr>
<td>不带 Hyper-V 的 Windows Server 2008 企业版</td>
<td>39BXF-X8Q23-P2WWT-38T2F-G3FPG</td>
</tr>
<tr>
<td>Windows Server 2008 HPC</td>
<td>RCTX3-KWVHP-BR6TB-RB6DM-6X7HP</td>
</tr>
<tr>
<td>Windows Server 2008 Datacenter</td>
<td>7M67G-PC374-GR742-YH8V4-TCBY3</td>
</tr>
<tr>
<td>不带 Hyper-V 的 Windows Server 2008 数据中心版</td>
<td>22XQ2-VRXRG-P8D42-K34TD-G3QQC</td>
</tr>
<tr>
<td>面向基于 Itanium 系统的 Windows Server 2008</td>
<td>4DWFP-JF3DJ-B7DTH-78FJB-PDRHK</td>
</tr>
</tbody></table>
<h3 id="早期版本的-WINDOWS"><a href="#早期版本的-WINDOWS" class="headerlink" title="早期版本的 WINDOWS"></a>早期版本的 WINDOWS</h3><h4 id="Windows-8-1"><a href="#Windows-8-1" class="headerlink" title="Windows 8.1"></a>Windows 8.1</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 8.1 专业版</td>
<td>GCRJD-8NW9H-F2CDX-CCM8D-9D6T9</td>
</tr>
<tr>
<td>Windows 8.1 专业版 N</td>
<td>HMCNV-VVBFX-7HMBH-CTY9B-B4FXY</td>
</tr>
<tr>
<td>Windows 8.1 企业版</td>
<td>MHF9N-XY6XB-WVXMC-BTDCT-MKKG7</td>
</tr>
<tr>
<td>Windows 8.1 企业版 N</td>
<td>TT4HM-HN7YT-62K67-RGRQJ-JFFXW</td>
</tr>
</tbody></table>
<h4 id="Windows-8"><a href="#Windows-8" class="headerlink" title="Windows 8"></a>Windows 8</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 8 专业版</td>
<td>NG4HW-VH26C-733KW-K6F98-J8CK4</td>
</tr>
<tr>
<td>Windows 8 专业版 N</td>
<td>XCVCF-2NXM9-723PB-MHCB7-2RYQQ</td>
</tr>
<tr>
<td>Windows 8 企业版</td>
<td>32JNW-9KQ84-P47T8-D8GGY-CWCK7</td>
</tr>
<tr>
<td>Windows 8 企业版 N</td>
<td>JMNMF-RHW7P-DMY6X-RF3DR-X2BQT</td>
</tr>
</tbody></table>
<h4 id="Windows-7"><a href="#Windows-7" class="headerlink" title="Windows 7"></a>Windows 7</h4><table>
<thead>
<tr>
<th>操作系统版本</th>
<th>KMS 客户端安装程序密钥</th>
</tr>
</thead>
<tbody><tr>
<td>Windows 7 专业版</td>
<td>FJ82H-XT6CR-J8D7P-XQJJ2-GPDD4</td>
</tr>
<tr>
<td>Windows 7 专业版 N</td>
<td>MRPKT-YTG23-K7D7T-X2JMM-QY7MG</td>
</tr>
<tr>
<td>Windows 7 专业版 E</td>
<td>W82YF-2Q76Y-63HXB-FGJG9-GF7QX</td>
</tr>
<tr>
<td>Windows 7 企业版</td>
<td>33PXH-7Y6KF-2VJC9-XBBR8-HVTHH</td>
</tr>
<tr>
<td>Windows 7 企业版 N</td>
<td>YDRBP-3D83W-TY26F-D46B2-XCKRJ</td>
</tr>
<tr>
<td>Windows 7 企业版 E</td>
<td>C29WB-22CC8-VJ326-GHFJW-H9DH4</td>
</tr>
</tbody></table>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T14:23:36.000Z" title="2023/8/6 22:23:36">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-06T14:24:08.358Z" title="2023/8/6 22:24:08">2023-08-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Qt/">Qt</a></span><span class="level-item">3 分钟读完 (大约398个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/Qt/qt-pop-dialog/">Qt实现弹出窗口，点击其他位置消失</a></h1><div class="content"><p>Qt实现弹出窗口，点击其他位置消失</p>
<p>一开始时想的很美好，写button的点击事件，然后在弹窗界面中写eventFilter(QEvent *e)事件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (event-&gt;<span class="built_in">type</span>() == QEvent::ActivationChange)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(QApplication::<span class="built_in">activeWindow</span>() != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;<span class="built_in">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> QWidget::<span class="built_in">event</span>(event);</span><br></pre></td></tr></table></figure>


<p>但是这样写发现一个问题，当我想实现点击按钮也可以关闭dialog时，不行了，因为EventFilter是第一触发事件，当我点按钮是，判断当前的活动窗口不是dialog，他先关闭，然后触发按钮的点击事件，再打开了dialog。很麻烦。</p>
<p>后来有了解到Qt有一个popup的属性</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info-&gt;<span class="built_in">setWindowFlags</span>(Qt::FramelessWindowHint | Qt::Popup);</span><br></pre></td></tr></table></figure>

<p>这样设置了之后，窗口是无边框且是点击其他位置关闭，但是还是会有上面的问题，没解决。</p>
<p>再后来，在一篇blog中看到了Qt::WA_NoMouseReplay属性<br>机翻一下：用于弹出窗口小部件。指示在弹出小部件关闭时不应重播最近的鼠标按下事件。该标志由小部件的作者设置，并在小部件每次接收到新的鼠标事件时由Qt内核清除。<br>大意就是它会拦截鼠标事件不会传递，专用于弹窗事件。<br>呜呜呜，原来Qt早就搞定了这个事件，找了半天，还是Qt不熟悉。<br>具体使用，在弹出的窗口里重写mousePressEvent(QMouseEvent *e)事件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InfoDialog::mousePressEvent</span><span class="params">(QMouseEvent *e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setAttribute</span>(Qt::WA_NoMouseReplay);</span><br><span class="line">    QDialog::<span class="built_in">mousePressEvent</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T14:19:36.000Z" title="2023/8/6 22:19:36">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-06T14:20:27.321Z" title="2023/8/6 22:20:27">2023-08-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Qt/">Qt</a></span><span class="level-item">3 分钟读完 (大约436个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/Qt/qt-os-define/">Qt的宏定义区分不同操作系统</a></h1><div class="content"><p>程序中遇到需要区分操作系统时，可使用qt的宏定义：</p>
<p>在<QtGlobal>中，定义了各个系统的宏定义</p>
<p>Q_OS_AIX<br>Defined on AIX.<br>Q_OS_ANDROID<br>Defined on Android.<br>Q_OS_BSD4<br>Defined on Any BSD 4.4 system.<br>Q_OS_BSDI<br>Defined on BSD&#x2F;OS.<br>Q_OS_CYGWIN<br>Defined on Cygwin.<br>Q_OS_DARWIN<br>Defined on Darwin-based operating systems such as macOS, iOS, watchOS, and tvOS.<br>Q_OS_DGUX<br>Defined on DG&#x2F;UX.<br>Q_OS_DYNIX<br>Defined on DYNIX&#x2F;ptx.<br>Q_OS_FREEBSD<br>Defined on FreeBSD.<br>Q_OS_HPUX<br>Defined on HP-UX.<br>Q_OS_HURD<br>Defined on GNU Hurd.<br>Q_OS_IOS<br>Defined on iOS.<br>Q_OS_IRIX<br>Defined on SGI Irix.<br>Q_OS_LINUX<br>Defined on Linux.<br>Q_OS_LYNX<br>Defined on LynxOS.<br>Q_OS_MAC<br>Deprecated synonym for Q_OS_DARWIN. Do not use.<br>Q_OS_MACOS<br>Defined on macOS.<br>Q_OS_NETBSD<br>Defined on NetBSD.<br>Q_OS_OPENBSD<br>Defined on OpenBSD.<br>Q_OS_OSF<br>Defined on HP Tru64 UNIX.<br>Q_OS_OSX<br>Deprecated synonym for Q_OS_MACOS. Do not use.<br>Q_OS_QNX<br>Defined on QNX Neutrino.<br>Q_OS_RELIANT<br>Defined on Reliant UNIX.<br>Q_OS_SCO<br>Defined on SCO OpenServer 5.<br>Q_OS_SOLARIS<br>Defined on Sun Solaris.<br>Q_OS_TVOS<br>Defined on tvOS.<br>Q_OS_ULTRIX<br>Defined on DEC Ultrix.<br>Q_OS_UNIX<br>Defined on Any UNIX BSD&#x2F;SYSV system.<br>Q_OS_UNIXWARE<br>Defined on UnixWare 7, Open UNIX 8.<br>Q_OS_WATCHOS<br>Defined on watchOS.<br>Q_OS_WIN32<br>Defined on 32-bit and 64-bit versions of Windows.<br>Q_OS_WIN64<br>Defined on 64-bit versions of Windows.<br>Q_OS_WIN<br>Defined on all supported versions of Windows. That is, if Q_OS_WIN32, Q_OS_WIN64, or Q_OS_WINRT is defined.<br>Q_OS_WINPHONE<br>Defined on Windows Phone 8.<br>Q_OS_WINRT<br>Defined for Windows Runtime (Windows Store apps) on Windows 8, Windows RT, and Windows Phone 8.</p>
<p>举例1：<br>记得需要有QObject的头文件，才可以</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> Q_OS_WIN</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>举例2：<br>对于标记了Q_OBJECT这个宏的类，其成员函数可以直接上面的区分操作系统的这些宏定义。</p>
<p>***.h文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DetailStepInfo</span> : <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">     ....................</span><br><span class="line"></span><br><span class="line">     ...................</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>***.cpp文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> DetailStepInfo::**************()</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> Q_OS_WIN</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> Q_OS_LINUX</span></span><br><span class="line">            QString command = <span class="built_in">QString</span>(<span class="string">&quot;chmod +rw /****************************&quot;</span>);</span><br><span class="line">            QProcess proc;</span><br><span class="line">            proc.<span class="built_in">execute</span>(command);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"> ...........................     </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T14:01:36.000Z" title="2023/8/6 22:01:36">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-06T14:02:36.193Z" title="2023/8/6 22:02:36">2023-08-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a></span><span class="level-item">几秒读完 (大约97个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/ACE-Editor/">ACE Editor修改自动换号缩进</a></h1><div class="content"><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38323427/remove-word-wrap-offset-in-ace-editor">https://stackoverflow.com/questions/38323427/remove-word-wrap-offset-in-ace-editor</a></p>
<p>This is controlled by indentedSoftWrap setting in ace, you can turn it off by running</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">editor.setOption(&quot;indentedSoftWrap&quot;, false);</span><br></pre></td></tr></table></figure>

<p>behaviours setting is completely unrelated and controls automatic insertion of closing brackets and tags.</p>
<p>So your code from the above would become</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> editor = ace.<span class="title function_">edit</span>(<span class="string">&quot;edittext&quot;</span>);</span><br><span class="line">editor.<span class="title function_">setOptions</span>(&#123;</span><br><span class="line">    <span class="attr">maxLines</span>: <span class="title class_">Infinity</span>, <span class="comment">// this is going to be very slow on large documents</span></span><br><span class="line">    <span class="attr">useWrapMode</span>: <span class="literal">true</span>, <span class="comment">// wrap text to view</span></span><br><span class="line">    <span class="attr">indentedSoftWrap</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">behavioursEnabled</span>: <span class="literal">false</span>, <span class="comment">// disable autopairing of brackets and tags</span></span><br><span class="line">    <span class="attr">showLineNumbers</span>: <span class="literal">false</span>, <span class="comment">// hide the gutter</span></span><br><span class="line">    <span class="attr">theme</span>: <span class="string">&quot;ace/theme/xcode&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T13:33:52.000Z" title="2023/8/6 21:33:52">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-06T13:43:42.345Z" title="2023/8/6 21:43:42">2023-08-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Ubuntu2Nas/">Ubuntu2Nas</a></span><span class="level-item">3 分钟读完 (大约440个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/Nas/jellyfin/">安装Jellyfin多媒体服务器</a></h1><div class="content"><p>由于 Jellyfin 的 GPL 协议和 Intel 的 media-driver (iHD) Linux 驱动（部分开源）在协议上不兼容的缘故，Jellyfin 官方的 Docker 镜像：jellyfin&#x2F;jellyfin 并不包含 Intel Linux 核显驱动。但是 Intel 的 QuickSync QSV 硬件加速依赖于该驱动，并且 Intel 10 代酷睿（Comet Lake）以及更新的处理器需要该驱动才能正常使用硬件加速。另外 VPP&#x2F;OpenCL 色调映射也需要该驱动才能正常运作。</p>
<p>开发者提供的中国特供版镜像<br>Docker 镜像： docker pull nyanmisaka&#x2F;jellyfin:latest</p>
<p>Jellyfin中国特供版+Docker镜像，含驱动，免折腾开箱即用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name=Jellyfin -p 8096:8096 \  # --name=Jellyfin 将容器名定义为 Jellyfin </span><br><span class="line">	-p 8920:8920 -p 7359:7359/udp -p 1900:1900/udp  #这三个端口为可选项 \</span><br><span class="line">	-v /var/docker/jellyfin/library:/config -v /var/docker/jellyfin/cache:/cache -v /data/media:/media \</span><br><span class="line">	-e TZ=Asia/Shanghai -e PUID=0 -e PGID=0 \	#将容器的时区设为上海,使用窗口在运行时使用root权限</span><br><span class="line">	--device=/dev/dri:/dev/dri \	#直通显卡给 Docker 容器，用于硬解</span><br><span class="line">	--add-host=api.themoviedb.org:13.224.161.90 \	#为容器增加 host 指向，加速海报与影视元数据的搜刮</span><br><span class="line">	--add-host=api.themoviedb.org:13.35.8.65 \</span><br><span class="line">	--add-host=api.themoviedb.org:13.35.8.93 \</span><br><span class="line">	--add-host=api.themoviedb.org:13.35.8.6 \</span><br><span class="line">	--add-host=api.themoviedb.org:13.35.8.54 \</span><br><span class="line">	--add-host=image.tmdb.org:138.199.37.230 \</span><br><span class="line">	--add-host=image.tmdb.org:108.138.246.49 \</span><br><span class="line">	--add-host=api.thetvdb.org:13.225.89.239 \</span><br><span class="line">	--add-host=api.thetvdb.org:192.241.234.54 \</span><br><span class="line">	--restart unless-stopped \</span><br><span class="line">	jellyfin/jellyfin:latest</span><br></pre></td></tr></table></figure>

<p>1.如果使用 linuxserver&#x2F;jellyfin 镜像，就把最后一行替换为下行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lscr.io/linuxserver/jellyfin:latest</span><br></pre></td></tr></table></figure>

<p>2.如果使用 nyanmisaka&#x2F;jellyfin  镜像，最把最后一行替换为下行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nyanmisaka/jellyfin:latest</span><br></pre></td></tr></table></figure>

<p>端口说明：</p>
<table>
<thead>
<tr>
<th>端口号</th>
<th>用途</th>
<th>可选项</th>
</tr>
</thead>
<tbody><tr>
<td>8096</td>
<td>默认http端口号</td>
<td>必须</td>
</tr>
<tr>
<td>8920</td>
<td>默认https端口号</td>
<td>可选</td>
</tr>
<tr>
<td>7359</td>
<td>让同一局域网中的客户端设备自动发现</td>
<td>可选</td>
</tr>
<tr>
<td>1900</td>
<td>DLNA的端口</td>
<td>可选</td>
</tr>
</tbody></table>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T11:53:36.000Z" title="2023/8/6 19:53:36">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-11T08:38:49.851Z" title="2023/8/11 16:38:49">2023-08-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a></span><span class="level-item">5 分钟读完 (大约736个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/ffmpeg-help/">ffmpeg的常用选项</a></h1><div class="content"><h2 id="map选项"><a href="#map选项" class="headerlink" title="map选项"></a>map选项</h2><p>默认情况下只在输入文件中的每种流里选择第一个流。</p>
<p>需要指定放入输出文件的流就需要使用-map选项。</p>
<p>用法举例：</p>
<p>-map 0<br> From input index #0 (the 1st input) select all streams.</p>
<p>-map 1:a<br> From input index #1 (the 2nd input) select all audio streams.</p>
<p>-map 3:s:4<br> From input index #3 (the 4th input) select subtitle stream index #4 (the fifth subtitle stream)。</p>
<p>-map 0 -map -0:s<br> Will select all streams from input index #0 (the 1st input) except subtitles. </p>
<h2 id="改变视频帧率"><a href="#改变视频帧率" class="headerlink" title="改变视频帧率"></a>改变视频帧率</h2><p>有两种方法可以改变输出文件的视频流帧率：</p>
<ol>
<li>使用 -r 选项</li>
<li>使用 fps滤镜。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i [inputfile] -r 30 [output]</span><br><span class="line">ffmpeg -i [inputfiel] -filter:v fps=30 [output]</span><br></pre></td></tr></table></figure>

<p>有两种方法可以改变输出文件的视频流帧率：</p>
<h2 id="改变默认音轨"><a href="#改变默认音轨" class="headerlink" title="改变默认音轨"></a>改变默认音轨</h2><p>使用ffmpeg修改默认的音频轨道，先取消第二音轨的默认值，在设置为第一音轨。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mkv -map 0:0 -map 0:1 -map 0:2  -c copy -disposition:a:1 0 -disposition:a:0 default -y output.mp4</span><br></pre></td></tr></table></figure>
<h2 id="改变音频采样率"><a href="#改变音频采样率" class="headerlink" title="改变音频采样率"></a>改变音频采样率</h2><p>-ar 48k 44.1k 96k</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.dsf -map 0:0 -c:0 flac -ar:0 96k output.flac</span><br></pre></td></tr></table></figure>

<h2 id="改变音频通道数量"><a href="#改变音频通道数量" class="headerlink" title="改变音频通道数量"></a>改变音频通道数量</h2><p>-ac </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.dsf -map 0:0 -c:0 flac -ar:0 96k -ac:0 2 -filter:0 aformat=channel_layouts=stereo output.flac</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.dsf -map 0:0 -c:0 flac -ar:0 96k -ac:0 6 -filter:0 aformat=channel_layouts=5.1 output.flac</span><br></pre></td></tr></table></figure>

<h2 id="改变音频位深-bit-depth"><a href="#改变音频位深-bit-depth" class="headerlink" title="改变音频位深 bit depth"></a>改变音频位深 bit depth</h2><p>-sample_fmt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.dsf -map 0:0 -c:0 flac -ar:0 96k -sample_fmt s24 -ac:0 6 -filter:0 aformat=channel_layouts=5.1 output.flac</span><br></pre></td></tr></table></figure>

<h2 id="截取视频片段"><a href="#截取视频片段" class="headerlink" title="截取视频片段"></a>截取视频片段</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg  -i 源文件名 -vcodec copy -acodec copy -ss 00:00:10 -to 00:00:15 目标文件名 -y</span><br></pre></td></tr></table></figure>

<h2 id="调整播放速度"><a href="#调整播放速度" class="headerlink" title="调整播放速度"></a>调整播放速度</h2><h3 id="调整视频文件中视频速度："><a href="#调整视频文件中视频速度：" class="headerlink" title="调整视频文件中视频速度："></a>调整视频文件中视频速度：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//2倍速播放</span><br><span class="line">ffmpeg -i test.mp4 -an -filter:v  &quot;setpts=0.5*PTS&quot;  out_test.mp4</span><br><span class="line"></span><br><span class="line">-i test.mp4是输入文件名</span><br><span class="line"> </span><br><span class="line">-an 将音频禁掉   （可以不加）</span><br><span class="line"> </span><br><span class="line">-filter:v 对视频进行处理</span><br><span class="line"> </span><br><span class="line">&quot;setpts=0.5PTS&quot; 设置时间戳参数PTS为原先的一半，可接受调整范围为[0.25,4]</span><br><span class="line"> </span><br><span class="line">out_test.mp4 输出视频文件</span><br><span class="line"> </span><br><span class="line">还可以在命令中加上指定fps（-r 60），使得不会丢帧</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="调整视频文件中音频速度："><a href="#调整视频文件中音频速度：" class="headerlink" title="调整视频文件中音频速度："></a>调整视频文件中音频速度：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.mp4 -filter:a &quot;atempo=2.0&quot; -vn out_test.mp4</span><br><span class="line">-i 后满test.mp4是输入文件名</span><br><span class="line"> </span><br><span class="line">-filter:a 对音频进行处理</span><br><span class="line"> </span><br><span class="line">&quot;atempo=2.0&quot;  设置播放速度是原来的2倍 ，  倍率调整范围[0.5, 2.0]</span><br><span class="line"> </span><br><span class="line">-vn 将视频禁掉   （可以不加）</span><br><span class="line"> </span><br><span class="line">out_test.mp4 输出视频文件</span><br><span class="line"> </span><br><span class="line">需要调整到4倍可以采取以下方法：</span><br><span class="line"> </span><br><span class="line">ffmpeg -i test.mp4 -filter:a &quot;atempo=2.0,atempo=2.0&quot; -vn out_test.mp4</span><br></pre></td></tr></table></figure>

<h3 id="同时调整视频文件的视频、音频："><a href="#同时调整视频文件的视频、音频：" class="headerlink" title="同时调整视频文件的视频、音频："></a>同时调整视频文件的视频、音频：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.mp4 -filter_complex &quot;[0:v]setpts=0.5*PTS[v];[0:a]atempo=2.0[a]&quot; -map &quot;[v]&quot; -map &quot;[a]&quot;  out_test.mp4</span><br></pre></td></tr></table></figure>

<p>如果不想丢帧就同时设置 <code>-r</code> ，把帧率设置为原帧率的2倍。</p>
<h2 id="metadata的使用"><a href="#metadata的使用" class="headerlink" title="metadata的使用"></a>metadata的使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i /Users/redtux/Movies/Becoming.Jane.2007.1080p.BluRay.x265.2Audio.mp4  -metadata title=&quot;Becoming.Jane.2007.1080p.BluRay.x265.2Audio-RARBG&quot; -map 0:0 -c:0 copy -metadata:s:0 title=&#x27;Becoming.Jane.2007.1080p.BluRay.x265-RARBG&#x27; -metadata:s:0 handler=&#x27;Becoming.Jane.2007.1080p.BluRay.x265-RARBG&#x27; -map 0:1 -c:1 copy -metadata:s:1 title=&quot;国语配音&quot; -metadata:s:1 handler=&quot;国语配音&quot; -metadata:s:1 language=&quot;chi&quot;  -disposition:1 default -map 0:2 -c:2 copy -metadata:s:2 title=&quot;English&quot; -metadata:s:2 handler=&quot;English&quot; -metadata:s:2 language=&quot;eng&quot;  -disposition:2  0 /Users/redtux/Movies/Becoming.Jane.2007.1080p.BluRay.x265.2Audio-RARBG.mp4</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T10:53:36.000Z" title="2023/8/6 18:53:36">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-06T10:53:59.093Z" title="2023/8/6 18:53:59">2023-08-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Ubuntu2Nas/">Ubuntu2Nas</a></span><span class="level-item">4 分钟读完 (大约591个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/Nas/ubuntu-ssh/">Ubuntu的SSH安全配置</a></h1><div class="content"><h2 id="查看登录日志文件："><a href="#查看登录日志文件：" class="headerlink" title="查看登录日志文件："></a>查看登录日志文件：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /var/log/auth.log</span><br></pre></td></tr></table></figure>

<h2 id="修改SSH的默认端口"><a href="#修改SSH的默认端口" class="headerlink" title="修改SSH的默认端口"></a>修改SSH的默认端口</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m tcp --dport 6022 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>保存并重启iptables防火墙</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure>

<p>修改SSH的默认端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>

<p>把 # Port 22 修改为 Port 6022</p>
<p>最好使用1024到65535之间的一个别人猜不到的端口号</p>
<p>重启ssh服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service sshd restart </span><br></pre></td></tr></table></figure>

<p>或 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/ssh restart</span><br></pre></td></tr></table></figure>

<p>可以用iptables检查端口是否开启</p>
<h2 id="禁止SSH的root登录"><a href="#禁止SSH的root登录" class="headerlink" title="禁止SSH的root登录"></a>禁止SSH的root登录</h2><p>修改 <code>/etc/ssh/sshd_config</code> 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin no</span><br></pre></td></tr></table></figure>

<p>重启ssh服务 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service sshd restart</span><br></pre></td></tr></table></figure>

<h2 id="禁用密码登陆，使用RSA私钥登录"><a href="#禁用密码登陆，使用RSA私钥登录" class="headerlink" title="禁用密码登陆，使用RSA私钥登录"></a>禁用密码登陆，使用RSA私钥登录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen #在客户端生成密钥</span><br><span class="line">ssh-copy-id myserver1 #将公钥添加至服务端</span><br></pre></td></tr></table></figure>

<p>还需要配置服务端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ssh/sshd_config</span><br><span class="line">PasswordAuthentication no #禁止密码认证</span><br><span class="line">PermitEmptyPasswords no #禁止空密码用户登录</span><br></pre></td></tr></table></figure>

<p>重启ssh服务 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service sshd restart</span><br></pre></td></tr></table></figure>

<h2 id="使用-Fail2ban"><a href="#使用-Fail2ban" class="headerlink" title="使用 Fail2ban"></a>使用 Fail2ban</h2><p>Ubuntu 16.04 系统源里带有 denyhosts ，到了Ubuntu 20.04默认不再包含。DenyHosts现在几乎不再更新了，所以来使用Fail2ban</p>
<p>检查是否安装了特定软件包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt list --installed | grep denyhosts</span><br><span class="line">sudo apt list --installed | grep fail2ban</span><br></pre></td></tr></table></figure>

<h3 id="安装fail2ban"><a href="#安装fail2ban" class="headerlink" title="安装fail2ban"></a>安装fail2ban</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install fail2ban</span><br></pre></td></tr></table></figure>

<h3 id="配置fail2ban"><a href="#配置fail2ban" class="headerlink" title="配置fail2ban"></a>配置fail2ban</h3><p>配置文件在 <code>/etc/fail2ban/jail.conf</code> 。 在配置文件的<code>[DEFAULT]</code>区，可以在此定义所有受监控的服务的默认参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"># 以空格分隔的列表，可以是 IP 地址、CIDR 前缀或者 DNS 主机名</span><br><span class="line"># 用于指定哪些地址可以忽略 fail2ban 防御</span><br><span class="line">ignoreip =  127.0.0.1/8 ::1</span><br><span class="line"> </span><br><span class="line"># 客户端主机被禁止的时长</span><br><span class="line">bantime = 60m</span><br><span class="line"></span><br><span class="line"># 查找失败次数的时长</span><br><span class="line">findtime = 10m</span><br><span class="line"> </span><br><span class="line"># 客户端主机被禁止前允许失败的次数 </span><br><span class="line">maxretry = 5</span><br></pre></td></tr></table></figure>

<p>根据上述配置，fail2ban会自动禁止在最近10分钟内有超过5次访问尝试失败的任意IP地址。一旦被禁，这个IP地址将会在1小时内一直被禁止访问 SSH 服务</p>
<p>保存配置后重启服务 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service fail2ban restart</span><br></pre></td></tr></table></figure>

<h3 id="查看fail2ban运行状态"><a href="#查看fail2ban运行状态" class="headerlink" title="查看fail2ban运行状态"></a>查看fail2ban运行状态</h3><p>验证fail2ban成功运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo fail2ban-client ping</span><br><span class="line">Server replied: pong</span><br></pre></td></tr></table></figure>

<p>检验fail2ban状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo fail2ban-client status</span><br><span class="line">Status</span><br><span class="line">|- Number of jail:      1</span><br><span class="line">`- Jail list:   sshd</span><br></pre></td></tr></table></figure>

<p>检验一个特定监狱的状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client status </span><br></pre></td></tr></table></figure>

<p>上面的命令会显示出被禁止IP地址列表</p>
<p>解锁特定的IP地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client set sshd unbanip 192.168.1.8</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-06T02:53:36.000Z" title="2023/8/6 10:53:36">2023-08-06</time>发表</span><span class="level-item"><time dateTime="2023-08-06T10:34:01.882Z" title="2023/8/6 18:34:01">2023-08-06</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Ubuntu2Nas/">Ubuntu2Nas</a></span><span class="level-item">1 分钟读完 (大约186个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/06/Nas/rustdesk-server/">自建开源远程桌面工具Rustdesk中继服务器</a></h1><div class="content"><p>Rustdesk支持Windows、macOS、Linux、iOS、Android、Web等几乎所有平台，客户端可以在<a target="_blank" rel="noopener" href="https://rustdesk.com/zh/">官方网站</a>下载，安装后自动分配id，立即可以使用。但是官方免费的服务器速度有点慢，官方还提供了服务器端程序，我们可以用docker来安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker volume create rustdesk_server_data</span><br><span class="line"></span><br><span class="line">docker run --name hbbs --net=host -v <span class="string">&quot;rustdesk_server_data:/root&quot;</span> -d rustdesk/rustdesk-server:latest hbbs -r www.redtux.cn</span><br><span class="line">docker run --name hbbr --net=host -v <span class="string">&quot;rustdesk_server_data:/root&quot;</span> -d rustdesk/rustdesk-server:latest hbbr</span><br></pre></td></tr></table></figure>

<p>这样自建的中继服务器就已经成功运行了，然后在自己的每个客户端设置中继服务器为自己的ip就可以了。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="胡乱折腾"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">胡乱折腾</p><p class="is-size-6 is-block">生命不息，折腾不止！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">7</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/tux0529" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/tux0529"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Qt/"><span class="level-start"><span class="level-item">Qt</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Ubuntu2Nas/"><span class="level-start"><span class="level-item">Ubuntu2Nas</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/"><span class="level-start"><span class="level-item">备忘录</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-18T08:46:25.000Z">2023-08-18</time></p><p class="title"><a href="/2023/08/18/ubuntu-server/">Ubuntu Server 常用管理</a></p><p class="categories"><a href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-15T08:30:00.000Z">2023-08-15</time></p><p class="title"><a href="/2023/08/15/Nas/nextcloud/">自建Nextcloud私有云盘</a></p><p class="categories"><a href="/categories/Ubuntu2Nas/">Ubuntu2Nas</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-14T04:10:00.000Z">2023-08-14</time></p><p class="title"><a href="/2023/08/14/windows-office-kms/">Microsoft Office及Windows的KMS激活步骤</a></p><p class="categories"><a href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-06T14:23:36.000Z">2023-08-06</time></p><p class="title"><a href="/2023/08/06/Qt/qt-pop-dialog/">Qt实现弹出窗口，点击其他位置消失</a></p><p class="categories"><a href="/categories/Qt/">Qt</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-06T14:19:36.000Z">2023-08-06</time></p><p class="title"><a href="/2023/08/06/Qt/qt-os-define/">Qt的宏定义区分不同操作系统</a></p><p class="categories"><a href="/categories/Qt/">Qt</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Nas%E5%B7%A5%E5%85%B7/"><span class="tag">Nas工具</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Qt/"><span class="tag">Qt</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Skills/"><span class="tag">Skills</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ffmpeg/"><span class="tag">ffmpeg</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kms%E6%BF%80%E6%B4%BB/"><span class="tag">kms激活</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="胡乱折腾" height="28"></a><p class="is-size-7"><span>&copy; 2023 redtux</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>